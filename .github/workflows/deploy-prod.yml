name: Deploy to Production Server (Mac Mini)

on:
  push:
    branches: ["main"]  # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ìš´ì˜ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read

jobs:
  build-and-deploy-prod:
    runs-on: self-hosted  # Mac Miniì˜ Self-hosted Runner ì‚¬ìš©

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 3. application-prod.yml ìƒì„±
      - name: Create application-prod.yml
        run: |
          mkdir -p ./src/main/resources
          cat > ./src/main/resources/application-prod.yml << 'EOF'
          ${{ secrets.APPLICATION_PROD }}
          EOF
        shell: bash

      # 4. Firebase Admin Key ìƒì„±
      - name: Create FirebaseAdminKey.json
        run: |
          rm -rf ./FirebaseAdminKey.json
          cat > ./FirebaseAdminKey.json << 'EOF'
          ${{ secrets.FIREBASE_ADMIN_KEY }}
          EOF
        shell: bash

      # 5. Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        shell: bash

      # 6. Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        run: ./gradlew clean build -x test
        shell: bash

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ (PRODUCTION íƒœê·¸)
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest .
          docker tag ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest ${{ secrets.DOCKER_USERNAME }}/ono:prod-${{ github.sha }}
        shell: bash

      # 8. Docker Hubì— í‘¸ì‹œ
      - name: Push to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:prod-${{ github.sha }}
        shell: bash

      # 9. .env íŒŒì¼ ìƒì„± (PRODUCTION)
      - name: Create .env file
        run: |
          cat > .env.prod << EOF
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          SPRING_CRYPTO_SECRET_KEY=${{ secrets.SPRING_CRYPTO_SECRET_KEY }}
          JWT_ACCESS_TOKEN_SECRET=${{ secrets.JWT_ACCESS_TOKEN_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION=1800000
          JWT_REFRESH_TOKEN_SECRET=${{ secrets.JWT_REFRESH_TOKEN_SECRET }}
          JWT_REFRESH_TOKEN_EXPIRATION=604800000
          CLOUD_AWS_S3_BUCKET=${{ secrets.CLOUD_AWS_S3_BUCKET }}
          CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}
          CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_KEY }}
          DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          ADMIN_IDENTIFIER=${{ secrets.ADMIN_IDENTIFIER }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF
        shell: bash

      # 10. Docker Composeë¡œ ë°°í¬ (PRODUCTION)
      - name: Deploy with Docker Compose
        run: |
          # MySQLê³¼ Redis ì‹œìž‘ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ìŠ¤í‚µ)
          docker-compose -f docker-compose.prod.yml up -d mysql-prod redis-prod

          # Spring Boot ìš´ì˜ ì•±ë§Œ ìž¬ì‹œìž‘
          docker-compose -f docker-compose.prod.yml stop app-prod || true
          docker-compose -f docker-compose.prod.yml rm -f app-prod || true
          docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app-prod

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 2ë¶„)
          echo "Waiting for production application to be healthy..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker-compose -f docker-compose.prod.yml ps app-prod | grep -q "healthy"; then
              echo "Production application is healthy!"
              break
            fi
            echo "Waiting... ($elapsed seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker-compose -f docker-compose.prod.yml ps

          # ë¡œê·¸ ì¶œë ¥ (ë§ˆì§€ë§‰ 50ì¤„)
          echo "=== Production Application Logs ==="
          docker-compose -f docker-compose.prod.yml logs --tail=50 app-prod
        shell: bash

      # 12. ì˜¤ëž˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬
      - name: Clean up old Docker images
        run: |
          docker image prune -f --filter "until=24h"
        shell: bash
        continue-on-error: true

      # 13. Discord ë°°í¬ ì•Œë¦¼
      - name: Send deployment notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="3066993"  # íŒŒëž€ìƒ‰ (ì„±ê³µ)
          if [ "$STATUS" != "success" ]; then
            COLOR="15158332"  # ë¹¨ê°„ìƒ‰ (ì‹¤íŒ¨)
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€ Production Deployment $STATUS\",
                \"description\": \"Environment: **PRODUCTION**\nURL: https://ono-prod.seungminki.shop\nBranch: \`${{ github.ref_name }}\`\nCommit: \`${{ github.sha }}\`\nAuthor: ${{ github.actor }}\",
                \"color\": $COLOR,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"
        shell: bash
        continue-on-error: true