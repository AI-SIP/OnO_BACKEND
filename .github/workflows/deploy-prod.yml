name: Deploy to Production Server (Mac Mini)

on:
  push:
    branches: ["main"]  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìš´ì˜ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read

jobs:
  build-and-deploy-prod:
    runs-on: self-hosted  # Mac Miniì˜ Self-hosted Runner ì‚¬ìš©

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          #cache: 'gradle'

      # 3. application-prod.yml ìƒì„±
      - name: Create application-prod.yml
        run: |
          mkdir -p ./src/main/resources
          echo "${{ secrets.APPLICATION_PROD }}" > ./src/main/resources/application.yml
        shell: bash

      # 4. Firebase Admin Key ìƒì„±
      - name: Create FirebaseAdminKey.json
        run: |
          rm -rf ./FirebaseAdminKey.json
          cat > ./FirebaseAdminKey.json << 'EOF'
          ${{ secrets.FIREBASE_ADMIN_KEY }}
          EOF
        shell: bash

      # 5. Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        shell: bash

      # 6. Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        run: ./gradlew clean build -x test
        shell: bash

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ (PRODUCTION íƒœê·¸)
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest .
          docker tag ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest ${{ secrets.DOCKER_USERNAME }}/ono:prod-${{ github.sha }}
        shell: bash

      # 8. Docker Hubì— í‘¸ì‹œ
      - name: Push to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:prod-latest
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:prod-${{ github.sha }}
        shell: bash

      # 9. .env íŒŒì¼ ìƒì„± (PRODUCTION)
      - name: Create .env file
        run: |
          cat > .env.prod << EOF
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          SPRING_CRYPTO_SECRET_KEY=${{ secrets.SPRING_CRYPTO_SECRET_KEY }}
          JWT_ACCESS_TOKEN_SECRET=${{ secrets.JWT_ACCESS_TOKEN_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION=1800000
          JWT_REFRESH_TOKEN_SECRET=${{ secrets.JWT_REFRESH_TOKEN_SECRET }}
          JWT_REFRESH_TOKEN_EXPIRATION=604800000
          CLOUD_AWS_S3_BUCKET=${{ secrets.CLOUD_AWS_S3_BUCKET }}
          CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}
          CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_KEY }}
          DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          ADMIN_IDENTIFIER=${{ secrets.ADMIN_IDENTIFIER }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF
        shell: bash

      # 10. Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬
      - name: Blue-Green Deployment
        run: |
          # MySQLê³¼ Redis ì‹œì‘ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ìŠ¤í‚µ)
          docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d mysql-prod redis-prod

          # Orphan ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ê¸°ì¡´ ono-app-prod ë“±)
          echo "Cleaning up orphan containers..."
          docker stop ono-app-prod 2>/dev/null || true
          docker rm ono-app-prod 2>/dev/null || true
          docker stop ono-app 2>/dev/null || true
          docker rm ono-app 2>/dev/null || true

          # í˜„ì¬ í™œì„±í™”ëœ í™˜ê²½ í™•ì¸ (Blueê°€ ì‹¤í–‰ ì¤‘ì´ë©´ Greenìœ¼ë¡œ ë°°í¬, ê·¸ ë°˜ëŒ€ë„ ë™ì¼)
          BLUE_RUNNING=$(docker ps --filter "name=ono-app-prod-blue" --filter "status=running" -q)
          GREEN_RUNNING=$(docker ps --filter "name=ono-app-prod-green" --filter "status=running" -q)

          if [ -n "$BLUE_RUNNING" ]; then
            # Blueê°€ ì‹¤í–‰ ì¤‘ì´ë©´ Greenìœ¼ë¡œ ë°°í¬
            CURRENT="blue"
            TARGET="green"
            CURRENT_PORT=8080
            TARGET_PORT=8081
          elif [ -n "$GREEN_RUNNING" ]; then
            # Greenì´ ì‹¤í–‰ ì¤‘ì´ë©´ Blueë¡œ ë°°í¬
            CURRENT="green"
            TARGET="blue"
            CURRENT_PORT=8081
            TARGET_PORT=8080
          else
            # ë‘˜ ë‹¤ ì‹¤í–‰ ì¤‘ì´ì§€ ì•Šìœ¼ë©´ Blueë¡œ ì´ˆê¸° ë°°í¬
            CURRENT="none"
            TARGET="blue"
            CURRENT_PORT=0
            TARGET_PORT=8080
          fi

          echo "Current active environment: $CURRENT (port $CURRENT_PORT)"
          echo "Deploying to target environment: $TARGET (port $TARGET_PORT)"

          # Target í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬
          if [ "$TARGET" = "green" ]; then
            docker-compose -f docker-compose.prod.yml --env-file .env.prod --profile green up -d app-prod-green
          else
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app-prod-blue
          fi

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 2ë¶„)
          echo "Waiting for $TARGET environment to be healthy..."
          timeout=120
          elapsed=0
          healthy=false

          while [ $elapsed -lt $timeout ]; do
            if docker ps | grep "ono-app-prod-$TARGET" | grep -q "healthy"; then
              echo "$TARGET environment is healthy!"
              healthy=true
              break
            fi
            echo "Waiting... ($elapsed seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          if [ "$healthy" = false ]; then
            echo "ERROR: $TARGET environment failed to become healthy within $timeout seconds"
            docker-compose -f docker-compose.prod.yml logs --tail=100 app-prod-$TARGET
            exit 1
          fi

          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (Blue-Green ì „í™˜)
          echo "Switching Nginx to $TARGET environment (port $TARGET_PORT)..."
          sudo /opt/ono/scripts/switch-nginx.sh $TARGET_PORT

          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ë¡œë“œ
          if sudo /opt/homebrew/bin/nginx -t; then
            sudo /opt/homebrew/bin/nginx -s reload
            echo "Nginx successfully switched to $TARGET environment"
          else
            echo "ERROR: Nginx configuration test failed"
            # ì›ë˜ í™˜ê²½ìœ¼ë¡œ ë¡¤ë°±
            sudo /opt/ono/scripts/switch-nginx.sh $CURRENT_PORT
            exit 1
          fi

          # 10ì´ˆ ëŒ€ê¸° í›„ ì´ì „ í™˜ê²½ ì¢…ë£Œ (ì•ˆì „ì„ ìœ„í•œ ëŒ€ê¸°)
          echo "Waiting 10 seconds before stopping old environment..."
          sleep 10

          # ì´ì „ í™˜ê²½ ì¢…ë£Œ (ì´ˆê¸° ë°°í¬ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
          if [ "$CURRENT" != "none" ]; then
            echo "Stopping old $CURRENT environment..."
            docker-compose -f docker-compose.prod.yml stop app-prod-$CURRENT || true
            docker-compose -f docker-compose.prod.yml rm -f app-prod-$CURRENT || true
          else
            echo "Initial deployment - no old environment to stop"
          fi

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "=== Current Container Status ==="
          docker-compose -f docker-compose.prod.yml ps

          # ë¡œê·¸ ì¶œë ¥ (ë§ˆì§€ë§‰ 50ì¤„)
          echo "=== $TARGET Environment Logs ==="
          docker-compose -f docker-compose.prod.yml logs --tail=50 app-prod-$TARGET
        shell: bash

      # 12. ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬
      - name: Clean up old Docker images
        run: |
          docker image prune -f --filter "until=24h"
        shell: bash
        continue-on-error: true

      # 13. Discord ë°°í¬ ì•Œë¦¼
      - name: Send deployment notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="3066993"  # íŒŒë€ìƒ‰ (ì„±ê³µ)
          if [ "$STATUS" != "success" ]; then
            COLOR="15158332"  # ë¹¨ê°„ìƒ‰ (ì‹¤íŒ¨)
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸš€ Production Deployment $STATUS\",
                \"description\": \"Environment: **PRODUCTION**\nURL: https://ono-prod.seungminki.shop\nBranch: \`${{ github.ref_name }}\`\nCommit: \`${{ github.sha }}\`\nAuthor: ${{ github.actor }}\",
                \"color\": $COLOR,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"
        shell: bash
        continue-on-error: true
