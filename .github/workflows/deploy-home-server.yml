name: Deploy to Home Server (Mac Mini)

on:
#  push:
#    branches: ["main"]  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  push:
      branches: ["chore/homeserver"]  # chore ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Mac Miniì˜ Self-hosted Runner ì‚¬ìš©

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'  # Gradle ìºì‹œ í™œì„±í™”

      # 3. application-prod.yml ìƒì„± (GitHub Secretsì—ì„œ ì£¼ì…)
      - name: Create application-prod.yml
        run: |
          mkdir -p ./src/main/resources
          echo "${{ secrets.APPLICATION_PROD }}" > ./src/main/resources/application-prod.yml
        shell: bash

      # 4. Firebase Admin Key ìƒì„± (GitHub Secretsì—ì„œ ì£¼ì…)
      - name: Create FirebaseAdminKey.json
        run: |
          rm -rf ./FirebaseAdminKey.json  # ê¸°ì¡´ íŒŒì¼/ë””ë ‰í† ë¦¬ ì‚­ì œ
          cat > ./FirebaseAdminKey.json << 'EOF'
          ${{ secrets.FIREBASE_ADMIN_KEY }}
          EOF
        shell: bash

      # 5. Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        shell: bash

      # 6. Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        run: ./gradlew clean build -x test
        shell: bash

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/ono:latest .
          docker tag ${{ secrets.DOCKER_USERNAME }}/ono:latest ${{ secrets.DOCKER_USERNAME }}/ono:${{ github.sha }}
        shell: bash

      # 8. Docker Hubì— ë¡œê·¸ì¸ ë° í‘¸ì‹œ (ì„ íƒì‚¬í•­: ë‹¤ë¥¸ ì„œë²„ì—ë„ ë°°í¬í•˜ë ¤ë©´)
      - name: Push to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/ono:${{ github.sha }}
        shell: bash

      # 9. .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          cat > .env << EOF
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          SPRING_CRYPTO_SECRET_KEY=${{ secrets.SPRING_CRYPTO_SECRET_KEY }}
          JWT_ACCESS_TOKEN_SECRET=${{ secrets.JWT_ACCESS_TOKEN_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION=1800000
          JWT_REFRESH_TOKEN_SECRET=${{ secrets.JWT_REFRESH_TOKEN_SECRET }}
          JWT_REFRESH_TOKEN_EXPIRATION=604800000
          CLOUD_AWS_S3_BUCKET=${{ secrets.CLOUD_AWS_S3_BUCKET }}
          CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}
          CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_KEY }}
          EXTERNAL_API_FAST_API_URL=${{ secrets.EXTERNAL_API_FAST_API_URL }}
          DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          ADMIN_IDENTIFIER=${{ secrets.ADMIN_IDENTIFIER }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF
        shell: bash

      # 10. Docker Composeë¡œ ë°°í¬
      - name: Deploy with Docker Compose
        run: |
          # MySQLê³¼ Redisê°€ ì—†ìœ¼ë©´ ì‹œì‘ (ìµœì´ˆ ë°°í¬ ì‹œ)
          docker-compose up -d mysql redis

          # Spring Boot ì•±ë§Œ ì¬ì‹œì‘ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ í›„ ìƒˆë¡œ ì‹œì‘)
          docker-compose stop app || true
          docker-compose rm -f app || true
          docker-compose up -d app

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 2ë¶„)
          echo "Waiting for application to be healthy..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker-compose ps app | grep -q "healthy"; then
              echo "Application is healthy!"
              break
            fi
            echo "Waiting... ($elapsed seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker-compose ps

          # ë¡œê·¸ ì¶œë ¥ (ë§ˆì§€ë§‰ 50ì¤„)
          echo "=== Application Logs ==="
          docker-compose logs --tail=50 app
        shell: bash

      # 11. ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬
      - name: Clean up old Docker images
        run: |
          # 24ì‹œê°„ ì´ìƒ ëœ dangling ì´ë¯¸ì§€ ì‚­ì œ
          docker image prune -f --filter "until=24h"

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ (ì„ íƒì‚¬í•­)
          # docker volume prune -f
        shell: bash
        continue-on-error: true  # ì •ë¦¬ ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬

      # 12. Slack/Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Send deployment notification
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          STATUS="${{ job.status }}"
          COLOR="3066993"  # íŒŒë€ìƒ‰ (ì„±ê³µ)
          if [ "$STATUS" != "success" ]; then
            COLOR="15158332"  # ë¹¨ê°„ìƒ‰ (ì‹¤íŒ¨)
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸš€ Deployment $STATUS\",
                \"description\": \"Branch: \`${{ github.ref_name }}\`\nCommit: \`${{ github.sha }}\`\nAuthor: ${{ github.actor }}\",
                \"color\": $COLOR,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"
        shell: bash
        continue-on-error: true